const Logger = require("../models/Logger");
const geoip = require("geoip-lite");
const UAParser = require("ua-parser-js");

const LogUserActivity = async (req, res, next) => {
    try {
        const IP_Address =
            req.headers["x-forwarded-for"]?.split(",")[0] ||
            req.ip ||
            req.socket?.remoteAddress ||
            req.connection?.remoteAddress;

        const uaString = req.headers["user-agent"];
        const parser = new UAParser(uaString);
        const ua = parser.getResult();

        const geo = geoip.lookup(IP_Address);

        const data = {
            IP_Address,
            UserAgent: uaString,
            device: ua.device?.model || "Unknown",
            os: ua.os?.name || "Unknown",
            browser: ua.browser?.name || "Unknown",
            location: {
                country: geo?.country || null,
                region: geo?.region || null,
                city: geo?.city || null
            },
            method: req.method,
            endpoint: req.originalUrl,
            status: res.statusCode,
            suspicious: false
        };

        let logger = await Logger.findOne({
            userId,
            redicertUrl: req.originalUrl
        });

        if (!logger) {
            logger = new Logger({
                userId,
                redicertUrl: req.originalUrl,
                Logs: [data]
            });
        } else {
            logger.Logs.push(data);
        }

        await logger.save();

        next();

    } catch (err) {
        console.error("Logger Error:", err.message);
        next();
    }
};

module.exports = {
    LogUserActivity
};